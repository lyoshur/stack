---
title: 第四章 线程安全与数据同步
description: Java高并发编程详解：多线程与架构设计（汪文君）- 第四章 线程安全与数据同步
slug: Java高并发编程详解：多线程与架构设计（汪文君）- 第四章 线程安全与数据同步
date: 2022-08-15 15:00:00+0000
categories:
    - Java高并发编程详解：多线程与架构设计（汪文君）
tags:
    - Java
---

# 第四章 线程安全与数据同步

## 概念

在《操作系统同步原语》 这篇文章中，介绍了操作系统在面对 进程/线程 间同步的时候，所支持的一些同步原语，其中 semaphore 信号量 和 mutex 互斥量是最重要的同步原语。

semaphore 信号量 和 mutex 互斥量 monitor 管程

在使用基本的 mutex 进行并发控制时，需要程序员非常小心地控制 mutex 的 down 和 up 操作，否则很容易引起死锁等问题。为了更容易地编写出正确的并发程序，所以在 mutex 和 semaphore 的基础上，提出了更高层次的同步原语 monitor，不过需要注意的是，操作系统本身并不支持 monitor 机制，实际上，monitor 是属于编程语言的范畴，当你想要使用 monitor 时，先了解一下语言本身是否支持 monitor 原语，例如 C 语言它就不支持 monitor，Java 语言支持 monitor。
一般的 monitor 实现模式是编程语言在语法上提供语法糖，而如何实现 monitor 机制，则属于编译器的工作，Java 就是这么干的。

monitor 的重要特点是，同一个时刻，只有一个 进程/线程 能进入 monitor 中定义的临界区，这使得 monitor 能够达到互斥的效果。但仅仅有互斥的作用是不够的，无法进入 monitor 临界区的 进程/线程，它们应该被阻塞，并且在必要的时候会被唤醒。显然，monitor 作为一个同步工具，也应该提供这样的管理 进程/线程 状态的机制。想想我们为什么觉得 semaphore 和 mutex 在编程上容易出错，因为我们需要去亲自操作变量以及对 进程/线程 进行阻塞和唤醒。monitor 这个机制之所以被称为“更高级的原语”，那么它就不可避免地需要对外屏蔽掉这些机制，并且在内部实现这些机制，使得使用 monitor 的人看到的是一个简洁易用的接口。

## 1 synchronized关键字

在jdk1.5之前，要解决这个问题需要使用synchronized关键字，synchronized提供了一种排他机制，在同一时间只能有一个线程执行某些操作。

synchronized关键字可以实现一个简单的策略来防止线程干扰和内存一致性错误，如果一个对象对多个线程是可见的，那么对该对象的读写操作都将通过同步的方式来进行。

1.1 synchronized关键字提供了一种锁的机制，能够确保共享变量的互斥访问，从而防止数据不一致问题的出现。

1.2 synchronized关键字包含了monitor enter和monitor exit 两个JVM指令，它能够保证在任何时候执行到monitor enter之前都必须从主内存获取数据，而不是从缓存中。在monitor exit运行成功后，共享变量被更新的值必须输入主内存。

1.3 synchronized的指令严格遵守java happends-before规则，一个monitor exit指令之前必定要有一个monitor enter。

## 2 This Monitor 和 Class Monitor

This Monitor锁定的是对象实例

Class Monitor锁定的是对象.class





