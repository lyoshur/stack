---
title: 第九章 类的加载过程
description: Java高并发编程详解：多线程与架构设计（汪文君）- 第九章 类的加载过程
slug: Java高并发编程详解：多线程与架构设计（汪文君）- 第九章 类的加载过程
date: 2022-08-16 10:21:00+0000
categories:
    - Java高并发编程详解：多线程与架构设计（汪文君）
tags:
    - Java
---

# 第九章 类的加载过程

ClassLoader的主要职责就是负责加载各种class文件到JVM中，ClassLoader是一个抽象的class，给定一个class的二进制文件名，ClassLoader会尝试加载并且在JVM中生成构成这个类的各个数据结构，然后使其分布在JVM对应的内存区域中。

## 1 类的加载过程简介

类的加载过程一般分为三个比较大的阶段，分别是加载阶段，连接阶段和初始化阶段。

- 加载阶段：主要负责查找并且加载类的二进制数据文件，其实就是class文件。
- 连接阶段：连接阶段做的工作比较多
  - 验证：主要确保类文件的正确性，比如class的版本，class文件的魔术因子是否正确
  - 准备：为类的静态变量分配内存，并为其初始化默认值
  - 解析：把类的符号引用转化为直接引用
- 初始化阶段：为类的静态变量赋予正确的初始化值

JVM对类的初始化是一个延迟的机制。当一个类在首次使用时才会被初始化，在同一个运行时包下，一个class只会被初始化一次。

## 2 类的主动使用和被动使用

JVM虚拟机规范规定，每个类或者接口被Java程序首次主动使用时才会对其进行初始化。当然随着JIT技术的越来越成熟，JVM运行期间的编译也越来越智能，不排除JVM在运行期间提前预判并且初始化某个类。

JVM同时规定了6种主动使用类的场景。

- 通过new关键字会导致类的初始化
- 访问类的静态变量
- 访问类的静态方法
- 对某个类进行反射操作
- 初始化子类会导致父类的初始化
- 启动类

被动使用

- 构造某个类的数组时
- 引用类的静态常量

## 3 类的加载过程详解

简单来说类的加载就是将class文件中的二进数据读取到内存之中，然后将该字节流所代表的静态存储结构转换为方法区中运行时的数据结构。并且在堆中生成一个该类的java.lang.Class对象，作为访问方法区数据结构的入口。

类加载的最终产物就是堆内存中的class对象，对同一个ClassLoader来讲，不管一个类被加载了多少次，对应到堆内存中的class对象始终是一个。

- 验证
  - 验证文件格式
  - 验证元数据
  - 验证字节码
  - 验证符号引用
- 准备
  - 当一个class的字节流通过了验证过程之后,就开始为该对象的类变量(静态变量)分配内存并设置初始值了。类变量的内存会被分配到方法区，不同与实例变量会被分配到堆内存。

```java
public class Demo {
    private static int a = 10;
    private final static int b = 10;
}
```

其中a在准备阶段不是10，而是初始值0。当然b还是10，因为final修饰的静态变量不会导致类的初始化，是一种被动引用。

【note】这里的b应该是属于静态常量，也就是被动使用的第二种情况，所以跟Demo类无关所以不需要走连接

当然更严谨的解释是b在类的编译阶段javac会将其value生成一个ConstantValue，直接赋予10；

- 解析
  - 类接口解析
  - 字段的解析
  - 类方法的解析
  - 接口方法的解析

